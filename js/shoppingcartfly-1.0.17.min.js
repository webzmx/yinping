/*! fly - v1.0.0 - 2014-12-22
 * https://github.com/amibug/fly
 * Copyright (c) 2014 wuyuedong; Licensed MIT */
!function (a) {
    a.fly = function (b, c) {
        var d = {
                version: "1.0.0",
                autoPlay: !0,
                vertex_Rtop: 20,
                speed: 1.2,
                start: {},
                end: {},
                onEnd: a.noop
            },
            e = this,
            f = a(b);
        e.init = function (a) {
            this.setOptions(a), !!this.settings.autoPlay && this.play()
        }, e.setOptions = function (b) {
            this.settings = a.extend(!0, {}, d, b);
            var c = this.settings,
                e = c.start,
                g = c.end;
            f.css({
                marginTop: "0px",
                marginLeft: "0px",
                position: "fixed",
                zIndex:1000
            }).appendTo("body"), null != g.width && null != g.height && a.extend(!0, e, {
                width: f.width(),
                height: f.height()
            });
            var h = Math.min(e.top, g.top) - Math.abs(e.left - g.left) / 3;
            h < c.vertex_Rtop && (h = Math.min(c.vertex_Rtop, Math.min(e.top, g.top)));
            var i = Math.sqrt(Math.pow(e.top - g.top, 2) + Math.pow(e.left - g.left, 2)),
                j = Math.ceil(Math.min(Math.max(Math.log(i) / .05 - 75, 30), 100) / c.speed),
                k = e.top == h ? 0 : -Math.sqrt((g.top - h) / (e.top - h)),
                l = (k * e.left - g.left) / (k - 1),
                m = g.left == l ? 0 : (g.top - h) / Math.pow(g.left - l, 2);
            a.extend(!0, c, {
                count: -1,
                steps: j,
                vertex_left: l,
                vertex_top: h,
                curvature: m
            })
        }, e.play = function () {
            this.move()
        }, e.move = function () {
            var b = this.settings,
                c = b.start,
                d = b.count,
                e = b.steps,
                g = b.end,
                h = c.left + (g.left - c.left) * d / e,
                i = 0 == b.curvature ? c.top + (g.top - c.top) * d / e : b.curvature * Math.pow(h - b.vertex_left, 2) + b.vertex_top;
            if (null != g.width && null != g.height) {
                var j = e / 2,
                    k = g.width - (g.width - c.width) * Math.cos(j > d ? 0 : (d - j) / (e - j) * Math.PI / 2),
                    l = g.height - (g.height - c.height) * Math.cos(j > d ? 0 : (d - j) / (e - j) * Math.PI / 2);
                f.css({
                    width: k + "px",
                    height: l + "px",
                    "font-size": Math.min(k, l) + "px"
                })
            }
            f.css({
                left: h + "px",
                top: i + "px"
            }), b.count++;
            var m = window.requestAnimationFrame(a.proxy(this.move, this));
            d == e && (window.cancelAnimationFrame(m), b.onEnd.apply(this))
        }, e.destory = function () {
            f.remove()
        }, e.init(c)
    }, a.fn.fly = function (b) {
        return this.each(function () {
            void 0 == a(this).data("fly") && a(this).data("fly", new a.fly(this, b))
        })
    }
}(jQuery);

//IE9 动画兼容代码
(function () {
    var lastTime = 0;
    var vendors = ['webkit', 'moz'];
    for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
        window.cancelAnimationFrame =
            window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];
    }

    if (!window.requestAnimationFrame){
        window.requestAnimationFrame = function (callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function () {
                    callback(currTime + timeToCall);
                },
                timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
    }
    if (!window.cancelAnimationFrame){
        window.cancelAnimationFrame = function (id) {
            clearTimeout(id);
        };
    }
}());

//添加商品到购物车
function addProduct(event,goodsImg,proId,type,number,proSpecValues) {
    var offset = $('#shopCart').offset();
    var positionLeft = $('#shopCart').offset().left + 7;
    var endTop = $('.rightbar-func').position().top - 85;
    var imgElement = '<img style="border-radius:50%" width="60" class="u-flyer"' + 'src="'+goodsImg +'"/>'
    var flyer = $(imgElement);
    flyer.fly({
        start: {
            left: event.clientX - 20,
            top: event.clientY - 50
        },
        end: {
            left: positionLeft,
            top: endTop,
            width: 20,
            height: 20
        },
        onEnd: function(){
            addPro(event,proId);//执行函数

                setTimeout(function(){
                    $(".shopCart_box").css("right","30px");
                    flyer.remove();
                },500)
        }
    });
}

//添加商品到购物车
// function addMulitProduct(event,goodsImg,proIdAndNums) {
//     var offset = $('#shopCart').offset();
//     var positionLeft = $('#shopCart').offset().left + 7;
//     var endTop = $('#quick_links').position().top - 85;
//     var imgElement = '<img class="u-flyer"' + 'src="'+goodsImg +'"/>'
//     var flyer = $(imgElement);
//     flyer.fly({
//         start: {
//             left: event.clientX - 20,
//             top: event.clientY - 50
//         },
//         end: {
//             left: positionLeft,
//             top: endTop,
//             width: 20,
//             height: 20
//         },
//         onEnd: function(){
//             var url = indexUrl + "/shoppingCart/addMultiToCartAjax?proIdAndNums=" + proIdAndNums +"&format=json&callback=?";
//             $.getJSON(url, function (result) {
//                 $(".u-flyer").css("opacity","0");

//                 if (!result.message && result.state == 2) {     //加入购物车成功
//                     initCartData(result);

//                     $(".shopCart_box_top").html('');
//                     var et = '<div class="shopCart_box_top_img">';
//                     et += '<img src="//static.ingping.com/yp/images/cart/addCart_success-1.0.0.png">';
//                     et += '</div>';
//                     et += '<div class="shopCart_box_top_text">';
//                     et += '<p class="shopCart_success_word">成功加入购物车!</p>';
//                     et += '<p>购物车保留时间有限，建议您尽快结算!</p>';
//                     et += '</div>';

//                     $(".shopCart_box_top").html(et);
//                 } else {    //加入购物车失败
//                     $(".shopCart_box_top").html('');
//                     var et = '<div class="shopCart_box_top_img">';
//                     et += '<img src="//static.ingping.com/yp/images/cart/addCart_error-1.0.0.png">';
//                     et += '</div>';
//                     et += '<div class="shopCart_box_top_text">';
//                     et += '<p class="shopCart_error_word">加入购物车失败!</p>';
//                     et += '<p>' + result.message + '</p>';
//                     et += '</div>';

//                     $(".shopCart_box_top").html(et);
//                 }
//                 //------Start加入购物车后初始化复选框和金额等信息------
//                 $("input:checkbox[name='proRelatesFittingsCB']").each(function () {
//                     $(this).prop("checked",false);
//                 });
//                 $(".selected-cnt").html(0);
//                 $(".sum_price").text($(".init_sum_price").text());
//                 //------End加入购物车后初始化复选框和金额等信息------
//                 if (result.alsoBuyProList) {
//                     $(".cart-list").html('');
//                     var e = '';
//                     for (var t = 0; t < result.alsoBuyProList.length; t++) {
//                         e += '<li class="cart-slide">';
//                         e += '    <a href="//item.ingping.com/' + result.alsoBuyProList[t].id + '.html" title="' + result.alsoBuyProList[t].brandName + result.alsoBuyProList[t].proName + '" target="_blank">';
//                         e += '       <img src="//img.ingping.com/images/product/M/' + result.alsoBuyProList[t].proImg + '" alt="' + result.alsoBuyProList[t].brandName + result.alsoBuyProList[t].proName + '" onerror="this.src=\'//static.ingping.com/yp/images/default/item/mid-1.0.0.jpg\'">';
//                         e += '       <p>￥' + result.alsoBuyProList[t].localPrice + '</p>';
//                         e += '   </a>';
//                         e += '</li>';
//                     }

//                     $(".cart-list").html(e);
//                     DY_scroll('.shopCart_box_bottom', 2, false,4);
//                 }

//                 setTimeout(function(){
//                     $(".shopCart_box").css("right","30px");
//                     flyer.remove();
//                 },500)
//             });
//         }
//     });
// }

//删除购物车中的活动货品
// function deleteGiftProduct(id, giftType, goodsNo) {
//     var removeActivityNoAndIds = "WARES_" + id + "GTYPE-" + giftType + "GOODSNO-" + goodsNo;
//     var url = indexUrl + "/shoppingCart/deleteGift?removeActivityNoAndIds=" + removeActivityNoAndIds + "&format=json&callback=?";

//     $.getJSON(url, function (result) {
//         if (result.flag == "true") {
//             reloadProduct();
//         }
//     });
// }

//删除购物车中商品
// function deleteProduct(id, giftType, goodsNo, activityNo) {
//     var removeActivityNoAndIds = "WARES_" + id + "GTYPE-" + giftType + "GOODSNO-" + goodsNo;
//     if (activityNo != '') {
//         removeActivityNoAndIds = activityNo + "_" + id;
//     }
//     var url = indexUrl + "/shoppingCart/removeFromCart?removeActivityNoAndIds=" + removeActivityNoAndIds + "&format=json&callback=?";

//     $.getJSON(url, function (result) {
//         if (result.flag == "true") {
//             initCartData(result);
//         }
//     });
// }

//购物车中商品数量减一
// function minusProductNumber(elementId, id, isLock) {
//     var num = parseInt($("#" + elementId).val());
//     if (isNaN(num)) { num = 1 }
//     if (num > 1) {
//         num = num - 1;

//         var url = indexUrl + "/shoppingCart/updateNumber?id=" + id + "&number=" + num + "&isLock=" + isLock + "&format=json&callback=?";

//         $.getJSON(url, function (result) {
//             if (result.flag == "true") {
//                 initCartData(result);
//             }
//         });
//     }
// }

// //购物车中商品数量加一
// function plusProductNumber(elementId, id, isLock) {
//     var num = parseInt($("#" + elementId).val()) + 1;
//     if (isNaN(num)) { num = 1 }

//     var url = indexUrl + "/shoppingCart/updateNumber?id=" + id + "&number=" + num + "&isLock=" + isLock + "&format=json&callback=?";

//     $.getJSON(url, function (result) {
//         if (result.flag == "true") {
//             initCartData(result);
//         } else if (result.storeFlag == "false"){
//             initCartData(result);
//             showYPAlert(result.returnMsg, '0');
//         } else {
//             alert("更新商品重置购物车失败！");
//             reloadProduct();
//         }
//     });
// }

// //重新加载购物车商品
// function reloadProduct() {
//     var url = indexUrl + "/shoppingCart/myCart?to=false&format=json&callback=?";
//     $.getJSON(url, function (result) {
//         if (result.result == "true") {
//             initCartData(result);
//         }
//     });
// }

function initCartData(result) {
    $(".cart-goods-list").html('');
    var cartItemSize = 0;
    var cartItemSelectedSize = 0;
    var cartItemNumber = 0;

    var e = '<ul>';

    if (result.availableActivityList && result.availableActivityList.length > 0) {
        e += '<li class="goods-li">';
        e += '<p>&nbsp;&nbsp;<img class="cart_tips_label" src="//static.ingping.com/yp/images/cart/cart_tips_label-1.0.0.png"> 您有活动可参与，请前往购物车参加活动</p>';
        e += '</li>';
    }

    if (result.proList && result.proList.length > 0) {
        for (var t = 0; t < result.proList.length; t++) {
            e += '<li rel="WARES_' + result.proList[t].id + 'GTYPE-' + result.proList[t].giftType + 'GOODSNO-' + result.proList[t].goodsNo + '" class="goods-li' + (result.proList[t].isSelected ? ' on' : '') + '">';
            e += '<input name="shopping_selectGoods" type="checkbox" onclick="selectGoods()" class="checkbox"' + (result.proList[t].isSelected ? ' checked' : '') + '>';
            e += '<div class="goodsImg">';
            e += '    <a href="//item.ingping.com/' + result.proList[t].productId + '.html" target="_blank">';
            e += '       <img src="//img.ingping.com/images/product/S/' + result.proList[t].defaultImgUrl + '" alt="' + result.proList[t].name + '" onerror="this.src=\'//static.ingping.com/yp/images/default/item/mid-1.0.0.jpg\'">';
            e += '   </a>';
            e += '</div>';
            e += '<div class="goodsMsg">';
            e += '   <div class="delet">';
            e += '      <a href="javascript:void(0)" onclick="deleteProduct(\'' + result.proList[t].id + '\', \'' + result.proList[t].giftType + '\', \'' + result.proList[t].goodsNo + '\', \'\')" class="goods-delete">';
            e += '          <img src="//static.ingping.com/yp/images/cart/ico_trash-1.0.2.png">';
            e += '      </a>';
            e += '   </div>';
            e += '   <h1>';
            e += '    <a href="//item.ingping.com/' + result.proList[t].productId + '.html" title="' + result.proList[t].name + '" target="_blank">';
            e +=            result.proList[t].name ;
            if (result.proList[t].spec) {
                e += ' ' + result.proList[t].spec;
            }
            e += '    </a>';
            e += '   </h1>';
            e += '   <div class="goodsPrice">';
            e += '      <div class="ingPrice">¥' + (result.proList[t].price * 0.01).toFixed(2) + '</div>';
            if ((result.proList[t].amount) * ((result.proList[t].discount) * 0.01)) {
                e += '  <span>优惠</span>';
            }
            if (result.proList[t].waresGiftList) {
                e += '  <span>赠品</span>';
            }
            e += '      <div class="goodsNumber">';
            e += '          <a href="javascript:void(0)" onclick="minusProductNumber(\'_rightGoodsNum' + (t+1) + '\', \'' + result.proList[t].id + '\', \'' + result.proList[t].giftType + '\')" class="goodsMinus' + (result.proList[t].number == 1 ? ' disabled' : '') + '"><s></s></a>';
            e += '          <input id="_rightGoodsNum' + (t+1) + '" class="num" value="' + result.proList[t].number + '">';
            e += '          <a href="javascript:void(0)" onclick="plusProductNumber(\'_rightGoodsNum' + (t+1) + '\', \'' + result.proList[t].id + '\', \'' + result.proList[t].giftType + '\')" class="goodsPlus"><s></s><b></b></a>';
            e += '       </div>';
            e += '    </div>';
            e += '  </div>';
            e += '</li>';

            cartItemSize++;
            if (result.proList[t].isSelected) {
                cartItemSelectedSize++;
                cartItemNumber += parseInt(result.proList[t].number);
            }
        }
    }

    e += '</ul>';

    if ((result.activityItemList && result.activityItemList.length > 0) || (result.giftProList && result.giftProList.length > 0)) {
        e += '<ul class="gift-ul">';

        if (result.activityItemList.length > 0) {
            for (var t = 0; t < result.activityItemList.length; t++) {
                for (var q = 0; q < result.activityItemList[t].activityWaresGoodsList.length; q++) {
                    e += '<li rel="' + result.activityItemList[t].no + '_' + result.activityItemList[t].activityWaresGoodsList[q].id + '" class="goods-li gift-li' + (result.activityItemList[t].activityWaresGoodsList[q].isSelected ? ' on' : '') + '">';
                    e += '<div class="goods-gift">';
                    e += '  <div class="gift-label">换购</div>';

                    if (result.activityItemList[t].name) {
                        e += '<p class="gift-tips" title="' + result.activityItemList[t].name + '">您已参加 ' + result.activityItemList[t].name + '</p>';
                    }

                    e += '</div>';
                    e += '<input name="shopping_selectGoods" type="checkbox" onclick="selectGoods()" class="checkbox"' + (result.activityItemList[t].activityWaresGoodsList[q].isSelected ? ' checked' : '') + '>';
                    e += '<div class="goodsImg">';
                    e += '    <a href="//item.ingping.com/' + result.activityItemList[t].activityWaresGoodsList[q].productId + '.html" target="_blank">';
                    e += '       <img src="//img.ingping.com/images/product/S/' + result.activityItemList[t].activityWaresGoodsList[q].defaultImgUrl + '" alt="' + result.activityItemList[t].activityWaresGoodsList[q].name + '" onerror="this.src=\'//static.ingping.com/yp/images/default/item/mid-1.0.0.jpg\'">';
                    e += '   </a>';
                    e += '</div>';
                    e += '<div class="goodsMsg">';
                    e += '   <div class="delet">';
                    e += '      <a href="javascript:void(0)" onclick="deleteProduct(\'' + result.activityItemList[t].activityWaresGoodsList[q].id + '\', \'\', \'\', \'' + result.activityItemList[t].no + '\')" class="goods-delete">';
                    e += '          <img src="//static.ingping.com/yp/images/cart/ico_trash-1.0.2.png">';
                    e += '      </a>';
                    e += '   </div>';
                    e += '    <h1>';
                    e += '    <a href="//item.ingping.com/' + result.activityItemList[t].activityWaresGoodsList[q].productId + '.html" title="' + result.activityItemList[t].activityWaresGoodsList[q].name + '" target="_blank">';
                    e +=            result.activityItemList[t].activityWaresGoodsList[q].name ;
                    if (result.activityItemList[t].activityWaresGoodsList[q].spec) {
                        e += ' ' + result.activityItemList[t].activityWaresGoodsList[q].spec;
                    }
                    e += '    </a>';
                    e += '   </h1>';
                    e += '   <div class="goodsPrice">';
                    e += '      <div class="ingPrice">¥' + (result.activityItemList[t].activityWaresGoodsList[q].price * 0.01).toFixed(2) + '</div>';
                    e += '      <div class="goodsNumber">';
                    e += '          <input id="_rightGoodsNum' + result.proList[t].id + '" class="num" value="' + result.activityItemList[t].activityWaresGoodsList[q].number + '">';
                    e += '       </div>';
                    e += '    </div>';
                    e += '</div>';
                    e += '</li>';

                    cartItemSize++;
                    if (result.activityItemList[t].activityWaresGoodsList[q].isSelected) {
                        cartItemSelectedSize++;
                        cartItemNumber += parseInt(result.activityItemList[t].activityWaresGoodsList[q].number);
                    }
                }
            }
        }
        if (result.giftProList.length > 0) {
            for (var t = 0; t < result.giftProList.length; t++) {
                e += '<li class="goods-li gift-li on">';
                e += '<div class="goods-gift">';
                e += '  <div class="gift-label">赠品</div>';

                if (result.giftProList[t].giftTypeName) {
                    e += '<p class="gift-tips" title="' + result.giftProList[t].giftTypeName + '">您已参加 ' + result.giftProList[t].giftTypeName + '</p>';
                }

                e += '</div>';
                e += '<div class="goodsImg" style="margin-left: 19px;">';
                e += '    <a href="//item.ingping.com/' + result.giftProList[t].productId + '.html" target="_blank">';
                e += '       <img src="//img.ingping.com/images/product/S/' + result.giftProList[t].defaultImgUrl + '" alt="' + result.giftProList[t].name + '" onerror="this.src=\'//static.ingping.com/yp/images/default/item/mid-1.0.0.jpg\'">';
                e += '   </a>';
                e += '</div>';
                e += '<div class="goodsMsg">';
                e += '   <div class="delet">';
                e += '      <a href="javascript:void(0)" onclick="deleteGiftProduct(\'' + result.giftProList[t].id + '\', \'' + result.giftProList[t].giftType + '\', \'' + result.giftProList[t].goodsNo + '\')" class="goods-delete">';
                e += '          <img src="//static.ingping.com/yp/images/cart/ico_trash-1.0.2.png">';
                e += '      </a>';
                e += '   </div>';
                e += '   <h1>';
                e += '    <a href="//item.ingping.com/' + result.giftProList[t].productId + '.html" title="' + result.giftProList[t].name + '" target="_blank">';
                e +=            result.giftProList[t].name ;
                if (result.giftProList[t].spec) {
                    e += ' ' + result.giftProList[t].spec;
                }
                e += '    </a>';
                e += '   </h1>';
                e += '   <div class="goodsPrice">';
                e += '      <div class="ingPrice">¥' + (result.giftProList[t].price * 0.01).toFixed(2) + '</div>';
                e += '      <div class="goodsNumber">';
                e += '          <input id="_rightGoodsNum' + result.proList[t].id + '" class="num" value="' + result.giftProList[t].number + '">';
                e += '       </div>';
                e += '    </div>';
                e += '</div>';
                e += '</li>';

                cartItemSize++;
                if (result.giftProList[t].isSelected) {
                    cartItemSelectedSize++;
                    cartItemNumber += parseInt(result.giftProList[t].number);
                }
            }
        }

        e += '</ul>';
    }

    $(".cart-goods-list").html(e).show();
    if (cartItemSize > 0) {
        $(".no-goods-list").hide();

        if (cartItemSize == cartItemSelectedSize) {
            $("[name = 'shopping_selectAll']").prop("checked", true);
        } else {
            $("[name = 'shopping_selectAll']").prop("checked", false);
        }
    }

    $(".shopping_amount").text(cartItemSize);
    $(".shopping_selectAmount").text(cartItemNumber);
    if (result.cartItemMoney) {
        $(".shopping_money").text((result.cartItemMoney * 0.01).toFixed(2));
    } else {
        if (result.sumRealMoney) {
            $(".shopping_money").text((result.sumRealMoney * 0.01).toFixed(2));
        } else {
            $(".shopping_money").text("0.00");
        }
    }
}

// if(IsPC()){
//     $("#quick_links_pop").panel({iWheelStep:32});
// }else{
//     $("#quick_links_pop").css("overflow","scroll");
// }